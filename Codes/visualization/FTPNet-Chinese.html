<!DOCTYPE html>
<html>
<head>
     <meta charset="UTF-8">
    <title>Mental Health Symptom Timeline</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .chart {
            margin: 20px auto;  /* Reduced vertical margin */
            width: 90%;
        }
        .axis text {
            font-size: 12px;
        }
        .axis-label {
            font-size: 14px;
            font-weight: bold;
        }
        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 2px;
        }
        .dot {
            fill: steelblue;
            stroke: #fff;
            stroke-width: 1.5px;
        }
        .dot:hover {
            fill: orange;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background: lightyellow;
            border: 1px solid #ccc;
            border-radius: 5px;
            pointer-events: none;
            font-size: 12px;
            max-width: 300px;
            box-shadow: 3px 3px 5px rgba(0,0,0,0.2);
        }
        .symptom-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 2px;  /* Reduced spacing */
            text-align: left;
            padding-left: 60px;
        }
        .symptom-desc {
            font-size: 14px;
            text-align: left;
            padding-left: 60px;
            margin-bottom: 10px;
        }
        .symptom-desc em {
            font-style: italic;
        }
        .note {
            font-style: italic;
            color: #666;
            margin-top: 2px;  /* Reduced to half of original spacing */
            font-size: 14px;
            text-align: left;
            padding-left: 60px;
        }
        .chart-container {
            margin-bottom: 30px;  /* Reduced spacing between charts */
        }
        .post-display {
            margin-top: 5px;  /* Reduced spacing */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            font-size: 14px;
        }
        .post-date {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
    </style>
</head>
<body>
    <div id="visualization"></div>

    <script>
        // [Previous rawData and symptoms definitions remain the same...]
        // Raw data
        const rawData = [
            {date:"2019-10-16",scores:{"抑郁情绪":0.73,"疲惫感":0.42,"自杀念头":0.88,"自责":0.80,"食欲紊乱":0.20},text:"即便是求助热线也放弃了我。我不配存在。"},
            {date:"2019-10-17",scores:{"抑郁情绪":0.67,"疲惫感":0.31,"自杀念头":0.82,"自责":0.75,"食欲紊乱":0.15},text:"对不起，我不该来到这个世界。"},
            {date:"2019-10-17",scores:{"抑郁情绪":0.52,"疲惫感":0.78,"自杀念头":0.68,"自责":0.60,"食欲紊乱":0.10},text:"我好累。我有点想放弃。"},
            {date:"2019-10-17",scores:{"抑郁情绪":0.63,"疲惫感":0.72,"自杀念头":0.77,"自责":0.65,"食欲紊乱":0.05},text:"我想永远睡下去。"},
            {date:"2019-10-18",scores:{"抑郁情绪":0.47,"疲惫感":0.83,"自杀念头":0.53,"自责":0.40,"食欲紊乱":0.85},text:"我只能梦想着睡觉。我没有食欲，对食物也没兴趣。"},
            {date:"2019-10-18",scores:{"抑郁情绪":0.58,"疲惫感":0.49,"自杀念头":0.93,"自责":0.70,"食欲紊乱":0.25},text:"我想死。"},
            {date:"2019-10-18",scores:{"抑郁情绪":0.63,"疲惫感":0.40,"自杀念头":0.41,"自责":0.35,"食欲紊乱":0.92},text:"我完全没有胃口，对食物也没兴趣。"},
            {date:"2019-10-19",scores:{"抑郁情绪":0.57,"疲惫感":0.48,"自杀念头":0.71,"自责":0.55,"食欲紊乱":0.30},text:"我难道不能对生活失去热情吗？"},
            {date:"2019-10-19",scores:{"抑郁情绪":0.43,"疲惫感":0.79,"自杀念头":0.27,"自责":0.35,"食欲紊乱":0.10},text:"被迫去睡觉。"},
            {date:"2019-10-20",scores:{"抑郁情绪":0.69,"疲惫感":0.33,"自杀念头":0.41,"自责":0.50,"食欲紊乱":0.15},text:"现在我可以毫不保留地哭了。"},
            {date:"2019-10-21",scores:{"抑郁情绪":0.51,"疲惫感":0.39,"自杀念头":0.94,"自责":0.65,"食欲紊乱":0.10},text:"我应该买更多的剃刀片吗？"},
            {date:"2019-10-21",scores:{"抑郁情绪":0.72,"疲惫感":0.47,"自杀念头":0.69,"自责":0.70,"食欲紊乱":0.20},text:"我很痛苦。"},
            {date:"2019-10-21",scores:{"抑郁情绪":0.59,"疲惫感":0.43,"自杀念头":0.48,"自责":0.65,"食欲紊乱":0.10},text:"很多人都食言了。"},
            {date:"2019-10-22",scores:{"抑郁情绪":0.37,"疲惫感":0.29,"自杀念头":0.32,"自责":0.20,"食欲紊乱":0.05},text:"物以类聚，人以群分。"},
            {date:"2019-10-24",scores:{"抑郁情绪":0.84,"疲惫感":0.37,"自杀念头":0.52,"自责":0.70,"食欲紊乱":0.15},text:"我好难过。"},
            {date:"2019-10-29",scores:{"抑郁情绪":0.79,"疲惫感":0.41,"自杀念头":0.49,"自责":0.65,"食欲紊乱":0.20},text:"我好难过。"},
            {date:"2019-10-30",scores:{"抑郁情绪":0.62,"疲惫感":0.38,"自杀念头":0.73,"自责":0.60,"食欲紊乱":0.15},text:"世界嘲笑我的疯狂；我嘲笑它的盲目。"},
            {date:"2019-11-03",scores:{"抑郁情绪":0.57,"疲惫感":0.83,"自杀念头":0.68,"自责":0.55,"食欲紊乱":0.25},text:"活着真是太累了。"},
            {date:"2019-11-03",scores:{"抑郁情绪":0.63,"疲惫感":0.47,"自杀念头":0.92,"自责":0.70,"食欲紊乱":0.20},text:"我想死。"},
            {date:"2019-11-04",scores:{"抑郁情绪":0.53,"疲惫感":0.69,"自杀念头":0.46,"自责":0.50,"食欲紊乱":0.60},text:"我整个早上都感觉很糟，心悸、呼吸急促。"},
            {date:"2019-11-05",scores:{"抑郁情绪":0.71,"疲惫感":0.58,"自杀念头":0.79,"自责":0.65,"食欲紊乱":0.30},text:"我快撑不住了。"},
            {date:"2019-11-05",scores:{"抑郁情绪":0.64,"疲惫感":0.39,"自杀念头":0.47,"自责":0.60,"食欲紊乱":0.15},text:"我一直不被喜欢。"},
            {date:"2019-11-06",scores:{"抑郁情绪":0.68,"疲惫感":0.51,"自杀念头":0.91,"自责":0.70,"食欲紊乱":0.20},text:"自杀未遂。"},
            {date:"2019-11-07",scores:{"抑郁情绪":0.61,"疲惫感":0.46,"自杀念头":0.72,"自责":0.55,"食欲紊乱":0.15},text:"如果我发出求救信号，有人会回应吗？"},
            {date:"2019-11-10",scores:{"抑郁情绪":0.42,"疲惫感":0.53,"自杀念头":0.29,"自责":0.30,"食欲紊乱":0.10},text:"去做体检。"},
            {date:"2019-11-19",scores:{"抑郁情绪":0.31,"疲惫感":0.28,"自杀念头":0.19,"自责":0.15,"食欲紊乱":0.05},text:"感觉好久没发帖了。这条只是更新一下我最近的情况。最近心情还不错，今天只是有点生气和不开心。"},
            {date:"2019-11-29",scores:{"抑郁情绪":0.57,"疲惫感":0.48,"自杀念头":0.89,"自责":0.70,"食欲紊乱":0.20},text:"我为什么没死？我真的想死。为什么没成功？如果成功了会好得多。"},
            {date:"2019-12-10",scores:{"抑郁情绪":0.61,"疲惫感":0.46,"自杀念头":0.94,"自责":0.75,"食欲紊乱":0.25},text:"我现在想死。"},
            {date:"2019-12-20",scores:{"抑郁情绪":0.43,"疲惫感":0.38,"自杀念头":0.31,"自责":0.35,"食欲紊乱":0.10},text:"去看心理医生做谈话疗法。"},
            {date:"2019-12-29",scores:{"抑郁情绪":0.49,"疲惫感":0.37,"自杀念头":0.42,"自责":0.50,"食欲紊乱":0.20},text:"有些事说起来容易，做起来难。个人经历也是一样——没人能真正理解别人的痛苦。人们说“保持快乐，保持乐观”，但真的有那么容易吗？"},
            {date:"2019-12-30",scores:{"抑郁情绪":0.63,"疲惫感":0.41,"自杀念头":0.87,"自责":0.70,"食欲紊乱":0.20},text:"有人吗，求你杀了我。"},
            {date:"2019-12-30",scores:{"抑郁情绪":0.52,"疲惫感":0.43,"自杀念头":0.81,"自责":0.60,"食欲紊乱":0.15},text:"这可能是我最后一年了。"},
            {date:"2020-01-08",scores:{"抑郁情绪":0.58,"疲惫感":0.39,"自杀念头":0.93,"自责":0.70,"食欲紊乱":0.15},text:"我想我已经决定好什么时候死了。"},
            {date:"2020-01-11",scores:{"抑郁情绪":0.69,"疲惫感":0.47,"自杀念头":0.83,"自责":0.75,"食欲紊乱":0.20},text:"生活毫无意义。"},
            {date:"2020-01-17",scores:{"抑郁情绪":0.53,"疲惫感":0.42,"自杀念头":0.59,"自责":0.60,"食欲紊乱":0.25},text:"我连喜欢的东西都不配拥有吗？他们说买我喜欢的东西是浪费钱。哈。"},
            {date:"2020-01-24",scores:{"抑郁情绪":0.64,"疲惫感":0.37,"自杀念头":0.89,"自责":0.70,"食欲紊乱":0.15},text:"求你，谁来现在杀了我。"},
            {date:"2020-02-03",scores:{"抑郁情绪":0.48,"疲惫感":0.43,"自杀念头":0.61,"自责":0.55,"食欲紊乱":0.20},text:"我只是个诅咒吗？"},
            {date:"2020-02-11",scores:{"抑郁情绪":0.59,"疲惫感":0.41,"自杀念头":0.72,"自责":0.65,"食欲紊乱":0.15},text:"像我这样自私冷漠的人不该存在于这个世界。"},
            {date:"2020-02-21",scores:{"抑郁情绪":0.47,"疲惫感":0.63,"自杀念头":0.39,"自责":0.45,"食欲紊乱":0.10},text:"最近我总是在过度思考。"},
            {date:"2020-03-03",scores:{"抑郁情绪":0.51,"疲惫感":0.42,"自杀念头":0.43,"自责":0.50,"食欲紊乱":0.10},text:"没人愿意相信我吗？"},
            {date:"2020-03-06",scores:{"抑郁情绪":0.43,"疲惫感":0.52,"自杀念头":0.37,"自责":0.40,"食欲紊乱":0.05},text:"在看书。而且，我好久没吃药了——可能一个多月了。"},
            {date:"2020-03-08",scores:{"抑郁情绪":0.59,"疲惫感":0.73,"自杀念头":0.68,"自责":0.55,"食欲紊乱":0.15},text:"好久没吃药了。以前医生问，“可以给你开药吗？”我自信地说，“好吧，既然如此。”但没想到停得这么早。现在，我无法入睡、无法进食、没有欲望。我不想吃药，也不想去医院。我已经写好了我的……（未完成的想法）。"},
            {date:"2020-03-15",scores:{"抑郁情绪":0.41,"疲惫感":0.49,"自杀念头":0.33,"自责":0.35,"食欲紊乱":0.10},text:"突然……"},
            {date:"2020-03-22",scores:{"抑郁情绪":0.53,"疲惫感":0.69,"自杀念头":0.47,"自责":0.50,"食欲紊乱":0.50},text:"我感觉很糟。昨天我只吃了一小块面包，胃痛。现在，我没有食欲，不想睡觉，甚至不渴。"},
            {date:"2020-04-02",scores:{"抑郁情绪":0.71,"疲惫感":0.48,"自杀念头":0.79,"自责":0.65,"食欲紊乱":0.25},text:"大家都说我没价值。如果真是这样，我为什么还会出生？"},
            {date:"2020-04-13",scores:{"抑郁情绪":0.62,"疲惫感":0.47,"自杀念头":0.69,"自责":0.60,"食欲紊乱":0.20},text:"经历了这么多，我会有伤疤吗？上周六，我妈妈想看我的手，但我不敢给她看——我怕她会骂我。"},
            {date:"2020-04-20",scores:{"抑郁情绪":0.49,"疲惫感":0.72,"自杀念头":0.51,"自责":0.55,"食欲紊乱":0.40},text:"今天我机械地吃东西，只为了完成。我睡不着——我真的不想吃药，但我吃了。这是很久以来的第一次。"}
        ];


        // Transform raw data into the format expected by the visualization
        const symptoms = {
            "抑郁情绪": {
                description: "示例帖子：<em>只是存在，而不是生活。这个世界感觉没有色彩，空虚。</em>",
                data: rawData.map(item => ({
                    date: item.date,
                    score: item.scores["抑郁情绪"],
                    text: item.text
                }))
            },
            "疲惫感": {
                description: "示例帖子：<em>生活的疲惫。光是活着就觉得很累。</em>",
                data: rawData.map(item => ({
                    date: item.date,
                    score: item.scores["疲惫感"],
                    text: item.text
                }))
            },
            "自杀念头": {
                description: "示例帖子：<em>站在窗边，想要跳下去...我今晚就要离开了，我希望没有痛苦。</em>",
                data: rawData.map(item => ({
                    date: item.date,
                    score: item.scores["自杀念头"],
                    text: item.text
                }))
            },
            "自责": {
                description: "示例帖子：<em>我就是个废物，我这种人不配被治好。</em>",
                data: rawData.map(item => ({
                    date: item.date,
                    score: item.scores["自责"],
                    text: item.text
                }))
            },
            "食欲紊乱": {
                description: "示例帖子：<em>我完全没有胃口，对食物也没兴趣。</em>",
                data: rawData.map(item => ({
                    date: item.date,
                    score: item.scores["食欲紊乱"],
                    text: item.text
                }))
            }
        };

        // Process data into 14-day periods
        function processData(symptomData) {
            const startDate = new Date("2019-10-16");
            const endDate = new Date("2020-04-20");
            const periodDays = 14;

            // Calculate number of periods
            const totalDays = (endDate - startDate) / (1000 * 60 * 60 * 24);
            const numPeriods = Math.ceil(totalDays / periodDays);

            // Initialize periods
            const periods = Array.from({length: numPeriods}, (_, i) => {
                const periodStart = new Date(startDate);
                periodStart.setDate(periodStart.getDate() + i * periodDays);
                return {
                    start: new Date(periodStart),
                    end: new Date(new Date(periodStart).setDate(periodStart.getDate() + periodDays - 1)),
                    posts: [],
                    maxScore: 0,
                    representativePost: null
                };
            });

            // Assign posts to periods and find max score
            symptomData.forEach(post => {
                const postDate = new Date(post.date);
                const periodIndex = Math.floor((postDate - startDate) / (1000 * 60 * 60 * 24 * periodDays));

                if (periodIndex >= 0 && periodIndex < periods.length) {
                    periods[periodIndex].posts.push(post);
                    if (post.score > periods[periodIndex].maxScore) {
                        periods[periodIndex].maxScore = post.score;
                        periods[periodIndex].representativePost = post;
                    }
                }
            });

            // Fill empty periods with nearest post
            let lastPost = null;
            for (let i = 0; i < periods.length; i++) {
                if (periods[i].posts.length > 0) {
                    lastPost = periods[i].representativePost;
                } else if (lastPost) {
                    periods[i].representativePost = lastPost;
                    periods[i].maxScore = lastPost.score * 0.8; // Reduce score for carried-over posts
                }
            }

            // Fill forward if needed
            let nextPost = null;
            for (let i = periods.length - 1; i >= 0; i--) {
                if (periods[i].posts.length > 0) {
                    nextPost = periods[i].representativePost;
                } else if (nextPost) {
                    periods[i].representativePost = nextPost;
                    periods[i].maxScore = nextPost.score * 0.8; // Reduce score for carried-over posts
                }
            }

            return periods.map(period => ({
                date: period.start,
                score: period.maxScore,
                post: period.representativePost
            }));
        }

        // Create visualization
        function createVisualization() {
            const container = d3.select("#visualization");

            Object.entries(symptoms).forEach(([symptom, data]) => {
                const processedData = processData(data.data);

                // Create a container for this symptom's chart
                const chartContainer = container.append("div")
                    .attr("class", "chart-container");

                // Add left-aligned symptom title above the chart
                chartContainer.append("div")
                    .attr("class", "symptom-title")
                    .text(symptom);

                // Add description below the title
                chartContainer.append("div")
                    .attr("class", "symptom-desc")
                    .html(data.description);

                // Create SVG for the chart
                const svg = chartContainer.append("svg")
                    .attr("width", 1000)
                    .attr("height", 400);

                // Set up margins and dimensions
                const margin = {top: 20, right: 30, bottom: 80, left: 60};  // Adjusted top margin
                const width = 1000 - margin.left - margin.right;
                const height = 400 - margin.top - margin.bottom;

                const chart = svg.append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                // Create scales
                const x = d3.scaleTime()
                    .domain(d3.extent(processedData, d => d.date))
                    .range([0, width]);

                const y = d3.scaleLinear()
                    .domain([0, 1.1])
                    .range([height, 0]);

                // Create axes
                const xAxis = d3.axisBottom(x)
                    .ticks(d3.timeMonth.every(1))
                    .tickFormat(d3.timeFormat("%Y-%m-%d"));

                const yAxis = d3.axisLeft(y)
                    .ticks(5);

                chart.append("g")
                    .attr("class", "axis x-axis")
                    .attr("transform", `translate(0,${height})`)
                    .call(xAxis);

                chart.append("g")
                    .attr("class", "axis y-axis")
                    .call(yAxis);

                // Add axis labels
                chart.append("text")
                    .attr("class", "axis-label")
                    .attr("transform", `translate(${width/2},${height + margin.bottom - 30})`)
                    .style("text-anchor", "middle")
                    .text("日期");

                chart.append("text")
                    .attr("class", "axis-label")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left + 15)
                    .attr("x", -height/2)
                    .style("text-anchor", "middle")
                    .text("症状严重性");

                // Create line generator
                const line = d3.line()
                    .x(d => x(d.date))
                    .y(d => y(d.score));

                // Add line to chart
                chart.append("path")
                    .datum(processedData)
                    .attr("class", "line")
                    .attr("d", line);

                // Add post display area (initially hidden)
                const postDisplay = chart.append("foreignObject")
                    .attr("x", 0)
                    .attr("y", height + 10)
                    .attr("width", width)
                    .attr("height", 60)
                    .style("visibility", "hidden")
                    .append("xhtml:div")
                    .attr("class", "post-display");

                // Add note below the chart (with reduced spacing)
                chartContainer.append("div")
                    .attr("class", "note")
                    .text("提示: 指向图中的点可以查看对应的代表帖子");

                // Add dots with tooltips and click handlers
                const tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);

                chart.selectAll(".dot")
                    .data(processedData)
                    .enter().append("circle")
                    .attr("class", "dot")
                    .attr("cx", d => x(d.date))
                    .attr("cy", d => y(d.score))
                    .attr("r", 5)
                    .on("mouseover", function(event, d) {
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);

                        tooltip.html(`<strong>${d.post.date}</strong><br/><br/>${d.post.text}`)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function() {
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    })
                    .on("click", function(event, d) {
                        // Update post display
                        postDisplay.selectAll("*").remove();

                        // Show the post display
                        postDisplay.style("visibility", "visible")
                            .append("div")
                            .attr("class", "post-date")
                            .text(`Post from ${d.post.date}`);

                        postDisplay.append("div")
                            .text(d.post.text);
                    });
            });
        }

        // Initialize visualization
        createVisualization();
    </script>
</body>
</html>